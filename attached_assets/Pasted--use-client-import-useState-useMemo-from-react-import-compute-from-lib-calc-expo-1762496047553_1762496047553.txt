"use client";
import { useState, useMemo } from "react";
import { compute } from "@/lib/calc";

export default function CalculatorCard({ compact = false }: { compact?: boolean }) {
  const [taxLiability, setTaxLiability] = useState(25000);
  const [creditPrice, setCreditPrice] = useState(0.89);
  const [platformFeePct, setPlatformFeePct] = useState(1.5);
  const [brokerFeePct, setBrokerFeePct] = useState(1.0);
  const [feeBase, setFeeBase] = useState<"face" | "subtotal">("face");

  const r = useMemo(
    () =>
      compute({ taxLiability, creditPrice, platformFeePct, brokerFeePct, feeBase }),
    [taxLiability, creditPrice, platformFeePct, brokerFeePct, feeBase]
  );

  const box = "rounded-2xl border border-white/10 bg-white/5 p-4 backdrop-blur";

  return (
    <div className={box}>
      <h3 className="text-xl font-semibold mb-4">Tax Credit Calculator</h3>
      <div className={`grid ${compact ? "grid-cols-1" : "grid-cols-2"} gap-4`}>
        <div className="grid gap-3">
          <label className="text-sm">Estimated Tax Liability ($)</label>
          <input className="rounded-xl bg-black/20 px-3 py-2 outline-none border border-white/10"
            type="number" value={taxLiability} onChange={(e)=>setTaxLiability(+e.target.value)} />
          <label className="text-sm">Credit Price (per $1)</label>
          <input className="rounded-xl bg-black/20 px-3 py-2 outline-none border border-white/10"
            type="number" step="0.01" value={creditPrice} onChange={(e)=>setCreditPrice(+e.target.value)} />
          <label className="text-sm">Platform Fee %</label>
          <input className="rounded-xl bg-black/20 px-3 py-2 outline-none border border-white/10"
            type="number" step="0.1" value={platformFeePct} onChange={(e)=>setPlatformFeePct(+e.target.value)} />
          <label className="text-sm">Broker Fee %</label>
          <input className="rounded-xl bg-black/20 px-3 py-2 outline-none border border-white/10"
            type="number" step="0.1" value={brokerFeePct} onChange={(e)=>setBrokerFeePct(+e.target.value)} />
          <div className="flex items-center gap-3">
            <span className="text-sm">Fees base:</span>
            <select value={feeBase} onChange={(e)=>setFeeBase(e.target.value as any)}
              className="rounded-xl bg-black/20 px-3 py-2 outline-none border border-white/10">
              <option value="face">Face</option>
              <option value="subtotal">Subtotal</option>
            </select>
          </div>
        </div>

        <div className="grid gap-3">
          <div className="rounded-xl bg-black/20 p-3">
            <div className="flex justify-between"><span>Face Value</span><span>${r.face.toLocaleString()}</span></div>
            <div className="flex justify-between"><span>Cost Before Fees</span><span>${r.costBeforeFees.toLocaleString()}</span></div>
            <div className="flex justify-between"><span>Platform Fee</span><span>${r.platformFee.toFixed(2)}</span></div>
            <div className="flex justify-between"><span>Broker Fee</span><span>${r.brokerFee.toFixed(2)}</span></div>
            <div className="flex justify-between font-semibold mt-2"><span>Total Cost</span><span>${r.totalCost.toLocaleString()}</span></div>
          </div>
          <div className="rounded-xl bg-emerald-600/20 border border-emerald-500/40 p-3">
            <div className="flex justify-between"><span>Savings</span><span className="font-semibold">${r.savings.toLocaleString()}</span></div>
            <div className="flex justify-between"><span>Effective Discount</span><span className="font-semibold">{r.effectiveDiscountPct.toFixed(1)}%</span></div>
          </div>
        </div>
      </div>
    </div>
  );
}