generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CompanyStatus {
  ACTIVE
  BLOCKED
  ARCHIVED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  ARCHIVE_COMPANY
  UNARCHIVE_COMPANY
  BLOCK_COMPANY
  UNBLOCK_COMPANY
  RESET_PASSWORD
}

enum AuditEntity {
  USER
  COMPANY
  PURCHASE
  CREDIT
  DOCUMENT
  SYSTEM
}

model User {
  id             String              @id @default(cuid())
  email          String              @unique
  hashedPassword String?
  role           String              @default("COMPANY")
  name           String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  companyId      String?
  company        Company?            @relation(fields: [companyId], references: [id])
  accountantClients AccountantClient[]
  uploadedDocuments Document[]
  auditLogs      AuditLog[]
}

model Company {
  id            String          @id @default(cuid())
  legalName     String
  ein           String?         @unique
  state         String?
  contactEmail  String
  taxLiability  Decimal?
  targetCloseYear Int?
  ownerId       String?
  status        CompanyStatus   @default(ACTIVE)
  archivedAt    DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  deletedAt     DateTime?
  users         User[]
  purchases     PurchaseOrder[]
  documents     Document[]
  holds         Hold[]
  auditLogs     AuditLog[]
  accountantLinks AccountantClient[]
}

model AccountantClient {
  id           String   @id @default(cuid())
  accountantId String
  companyId    String
  createdAt    DateTime @default(now())
  accountant   User     @relation(fields: [accountantId], references: [id])
  company      Company  @relation(fields: [companyId], references: [id])

  @@unique([accountantId, companyId])
}

model CreditInventory {
  id               String          @id @default(cuid())
  creditType       String
  taxYear          Int
  jurisdiction     String?
  stateRestriction String?
  faceValueUSD     Decimal
  minBlockUSD      Decimal
  pricePerDollar   Decimal
  availableUSD     Decimal
  closeBy          DateTime?
  brokerName       String?
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  status           String          @default("ACTIVE")
  holds            Hold[]
  purchaseOrders   PurchaseOrder[]
}

model Hold {
  id          String          @id @default(cuid())
  inventoryId String
  companyId   String
  amountUSD   Decimal
  expiresAt   DateTime
  createdAt   DateTime        @default(now())
  status      String          @default("ACTIVE")
  inventory   CreditInventory @relation(fields: [inventoryId], references: [id])
  company     Company         @relation(fields: [companyId], references: [id])
}

model PurchaseOrder {
  id                    String            @id @default(cuid())
  companyId             String
  inventoryId           String
  amountUSD             Decimal
  pricePerDollar        Decimal
  subtotalUSD           Decimal
  feesUSD               Decimal
  totalUSD              Decimal
  stripeSessionId       String?
  status                String            @default("PENDING_PAYMENT")
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  complianceStatus      String            @default("MISSING")
  brokerStatus          String            @default("PENDING")
  closingCertificateUrl String?
  brokerPackageUrl      String?
  company               Company           @relation(fields: [companyId], references: [id])
  inventory             CreditInventory   @relation(fields: [inventoryId], references: [id])
}

model Document {
  id           String   @id @default(cuid())
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  filename     String
  mimeType     String
  sizeBytes    Int
  storagePath  String
  uploadedById String?
  uploadedBy   User?    @relation(fields: [uploadedById], references: [id])
  createdAt    DateTime @default(now())
  deletedAt    DateTime?
  
  @@index([companyId])
}

model AuditLog {
  id          String      @id @default(cuid())
  timestamp   DateTime    @default(now())
  actorId     String?
  actorEmail  String?
  action      AuditAction @default(CREATE)
  entity      AuditEntity @default(SYSTEM)
  entityId    String?
  details     Json?
  companyId   String?
  actor       User?       @relation(fields: [actorId], references: [id])
  company     Company?    @relation(fields: [companyId], references: [id])

  @@index([timestamp])
  @@index([entity, entityId])
  @@index([companyId])
  @@index([actorId])
}
